{% extends 'blog/base/base.html' %}

{% load static %}

{% block content %}
    <div class="messenger container clearfix">
        <div class="row">
            
            <div class="col-md-4">
                <div class="people-list" id="people-list">
                    <div class="search">
                        <input type="text" placeholder="search" />
                        <i class="fa fa-search"></i>
                    </div>

                    <ul class="list">
                        {% for thread in user.threads.all %}
                            {% if thread.messages.count > 0 %}
                            <li class="clearfix">
                                {% for thread_user in thread.users.all %}
                                    {% if thread_user != user %} 
                                        {% if thread_user.profile.image %}
                                            <img src="{{ thread_user.profile.image.url }}" alt="avatar" class="avatar"/>
                                        {% else %}
                                            <img src="{% static 'registration/img/no-avatar.jpg' %}" class="avatar">
                                        {% endif %}
                                        <div class="about">
                                            <div class="name">
                                                <a href="{% url 'messenger:detaill' thread.pk %}">
                                                    {{ thread_user }}
                                                </a>
                                            </div>
                                            <div class="status">
                                                <!-- <i class="fa fa-circle online"></i> online -->
                                                <p><i>{{ thread.messages.last.content | string_trunc:25 }}</i></p>
                                                <p><small>{{ thread.messages.last.created_at|date:'d-m-Y' }}</small></p>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </li> 
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="col-md-8">
                <div class="chat">
                    <div class="chat-header clearfix">
                        {% for thread_user in thread.users.all %}
                            {% if thread_user.pk != user.pk %}       
                                <img src="{{ thread_user.profile.image.url }}" class="avatar" alt="avatar" />
                                <div class="chat-about">
                                    <div class="chat-with">
                                        Conversation with <a href="{% url 'blog:user_profile' thread_user %} ">{{ thread_user }}</a>
                                    </div>
                                    <div class="chat-num-messages">
                                        Already <span id="messages-count" class="messages-count">{{ thread.messages.count }}</span> messages
                                    </div>
                                </div>
                                <!-- <i class="fa fa-star"></i> -->
                            {% endif %}
                        {% endfor %}                                           
                    </div>

                    <input id="last-update" type="hidden" value="{{ thread.updated_at | date:'U' }}" />
                    
                    <div id="thread" class="chat-history">
                        <ul id="thread-list">
                            {% for message in thread.messages.all %}
                                {% if user.pk == message.user.pk %}
                                <li>
                                    <div class="message-data">
                                        <span class="message-data-name"><i class="fa fa-circle online"></i> Me</span>
                                        <span class="message-data-time">{{ message.created_at | date:'M. d, Y, H:i' }}</span>
                                    </div>
                                    <div class="message my-message">
                                        {{ message.content }}
                                    </div>
                                </li>
                                {% else %}
                                <li class="clearfix">
                                    <div class="message-data align-right">
                                        <span class="message-data-time" >{{ message.created_at | date:'M. d, Y, H:i' }}</span> &nbsp; &nbsp;
                                        <span class="message-data-name" >{{ message.user }}</span> <i class="fa fa-circle me"></i>                        
                                    </div>
                                    <div class="message other-message float-right">
                                        {{ message.content }}
                                    </div>
                                </li>
                                {% endif %}							
                            {% endfor %}				
                        </ul>
                        
                    </div>
                    
                    <div class="chat-message clearfix">
                        <textarea name="message-to-send" class="form-control mb-2" id="message-to-send" placeholder="Type your message" rows="3"></textarea>
                                
                        <!-- <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp;
                        <i class="fa fa-file-image-o"></i> -->
                        
                        <button id="send" class="btn btn-primary btn-sm" disabled>Send</button>
                    </div>
                
                </div>
            
            </div>

        </div>
    </div>

{% endblock content %}


{% block extra_scripts %}

	<script>

		var send_btn = document.getElementById("send");
		var content_input = document.getElementById("message-to-send");

		send_btn.addEventListener("click", function(){
			var content = content_input.value
			content = encodeURIComponent(content) // Quitar caracteres especiales
			if(content.length > 0){
				
				content_input.value = ''
				send_btn.disabled = true
				
				const url = "{% url 'messenger:add' thread.pk %}" + "?content=" + content
				
				fetch(url, {'credentials': 'include'}).then(response => response.json()).then(function(data){
					if(data.created){
						// Si el mensaje es el primero
						if (data.first){
							window.location.href = "{% url 'messenger:detaill' thread.pk %}"
						}
                        var message = document.createElement("li")
						message.innerHTML = '<div class="message-data"><span class="message-data-name"><i class="fa fa-circle online"></i> Me</span><span class="message-data-time">' + formateDatetime(data.created_at) + '</span></div><div class="message my-message">' + decodeURIComponent(content) + '</div>'
						document.getElementById("thread-list").appendChild(message)
                        document.getElementById("messages-count").innerHTML = data.total
                        document.getElementById("last-update").setAttribute('value', data.last_update)
                        
						ScrollBottomInThread()
					}else{
						alert("Something weng wrong...")
					}
				})
			}
		})

		content_input.addEventListener("keyup", function(){
			if(!this.checkValidity() || !this.value){
			    send_btn.disabled = true
			}else{
			    send_btn.disabled = false
			}
		});

        const url = "{% url 'messenger:check-updates' %}"            
        const user_id = "{{ user.pk }}"        

        function checkUpdates() {
            setTimeout(function() {
                var last_update = document.getElementById("last-update").value
                fetch(url, {
                    credentials: 'include',
                    method: 'POST',
                    headers: {
                        "X-CSRFToken": getCookie("csrftoken"),
                        "Accept": "application/json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({"thread_id": "{{ thread.pk }}", "updated_at": last_update})
                }).then(
                    response => response.json()
                ).then(function(data) {
                    if(data.update){         
                        var html = data.thread_list.map(function(message) {
                            if (message.user_id==user_id){                            
                                return '<li><div class="message-data"><span class="message-data-name"><i class="fa fa-circle online"></i> Me </span><span class="message-data-time">' + formateDatetime(message.created_at) + '</span></div><div class="message my-message">' + message.content + '</div></li>'
                            } else {
                                return '<li class="clearfix"><div class="message-data align-right"><span class="message-data-time">' + formateDatetime(message.created_at) + '</span> \&nbsp; \&nbsp;<span class="message-data-name" > ' + message.author + '</span> <i class="fa fa-circle me"></i></div><div class="message other-message float-right">' + message.content + '</div></li>'
                            }
                        }).join('')
						const thread_list = document.getElementById("thread-list")

                        while(thread_list.firstChild) {
                            thread_list.firstChild.remove()
                        }

                        thread_list.innerHTML = html            
                        document.getElementById("messages-count").innerHTML = data.thread_list.length
                        document.getElementById("last-update").setAttribute('value', data.last_update)
                        ScrollBottomInThread()
                    }
                    checkUpdates()
                })
            }, 5000)
        }

		// Forzar el Scroll
		function ScrollBottomInThread(){
			var thread = document.getElementById("thread")
			thread.scrollTop = thread.scrollHeight
		}

        ScrollBottomInThread()
        checkUpdates()
        
    </script>
    
{% endblock extra_scripts %}