{% extends 'blog/base/base.html' %}

{% load static %}

{% block content %}
    <div class="messenger container clearfix">
        <div class="row">
            
            <div class="col-md-4">
                <div class="people-list" id="people-list">
                    <div class="search">
                        <input type="text" placeholder="search" />
                        <i class="fa fa-search"></i>
                    </div>

                    <ul class="list">
                        {% for thread in request.user.threads.all %}
                            {% if thread.messages.count > 0 %}
                            <li class="clearfix">
                                {% for user in thread.users.all %}
                                    {% if user != request.user %} 
                                        {% if user.profile.image %}
                                            <img src="{{ user.profile.image.url }}" alt="avatar" class="avatar"/>
                                        {% else %}
                                            <img src="{% static 'registration/img/no-avatar.jpg' %}" class="avatar">
                                        {% endif %}
                                        <div class="about">
                                            <div class="name">
                                                <a href="{% url 'messenger:detaill' thread.pk %}">
                                                    {{ user }}
                                                </a>
                                            </div>
                                            <div class="status">
                                                <!-- <i class="fa fa-circle online"></i> online -->
                                                <p>{{ thread.messages.last.created_at|date:'d-m-Y' }}</p>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </li> 
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="col-md-8">
                <div class="chat">
                    <div class="chat-header clearfix">
                        {% for user in thread.users.all %}
                            {% if user.pk != request.user.pk %}       
                                <img src="{{ user.profile.image.url }}" class="avatar" alt="avatar" />
                                <div class="chat-about">
                                    <div class="chat-with">
                                        Conversation with <a href="{% url 'blog:user_profile' user %} ">{{ user }}</a>
                                    </div>
                                    <div class="chat-num-messages">
                                        already <span class="messages-count">{{ thread.messages.count }}</span> messages</div>
                                </div>
                                <!-- <i class="fa fa-star"></i> -->
                            {% endif %}
                        {% endfor %}
                                                                                    
                    </div>
                    
                    <div id="thread" class="chat-history">
                        <ul id="thread-list">
                            {% for message in thread.messages.all %}
                                {% if request.user.pk == message.user.pk %}
                                <li>
                                    <div class="message-data">
                                        <span class="message-data-name"><i class="fa fa-circle online"></i> {{ message.user }}</span>
                                        <span class="message-data-time">{{ message.created_at | date:'M. d, Y, h:i A' }}</span>
                                    </div>
                                    <div class="message my-message">
                                        {{ message.content }}
                                    </div>
                                </li>
                                {% else %}
                                <li class="clearfix">
                                    <div class="message-data align-right">
                                        <span class="message-data-time" >{{ message.created_at | date:'M. d, Y, h:i A' }}</span> &nbsp; &nbsp;
                                        <span class="message-data-name" >{{ message.user }}</span> <i class="fa fa-circle me"></i>                        
                                    </div>
                                    <div class="message other-message float-right">
                                        {{ message.content }}
                                    </div>
                                </li>
                                {% endif %}							
                            {% endfor %}				
                        </ul>
                        
                    </div>
                    
                    <div class="chat-message clearfix">
                        <textarea name="message-to-send" class="form-control mb-2" id="message-to-send" placeholder="Type your message" rows="3"></textarea>
                                
                        <!-- <i class="fa fa-file-o"></i> &nbsp;&nbsp;&nbsp;
                        <i class="fa fa-file-image-o"></i> -->
                        
                        <button id="send" class="btn btn-primary btn-sm" disabled>Send</button>
                    </div>
                
                </div>
            
            </div>

        </div>
    </div>

{% endblock content %}


{% block extra_scripts %}

	<script>

		var send_btn = document.getElementById("send");
		var content_input = document.getElementById("message-to-send");

		send_btn.addEventListener("click", function(){
			var content = content_input.value
			content = encodeURIComponent(content) // Quitar caracteres especiales
			if(content.length > 0){
				
				content_input.value = ''
				send_btn.disabled = true
				
				const url = "{% url 'messenger:add' thread.pk %}" + "?content=" + content
				
				fetch(url, {'credentials': 'include'}).then(response => response.json()).then(function(data){
					if(data.created){
						// Si el mensaje es el primero
						if (data.first){
							window.location.href = "{% url 'messenger:detaill' thread.pk %}"
						}

                        var message = document.createElement("li")
						message.innerHTML = '<img src="{{ user.profile.image.url }}" class="avatar-message"><small><i>About a few seconds</i></small><br />' + decodeURIComponent(content)
						message.innerHTML = '<div class="message-data"><span class="message-data-name"><i class="fa fa-circle online"></i> {{ user }}</span><span class="message-data-time">' + data.created_at + '</span></div><div class="message my-message">' + decodeURIComponent(content) + '</div>'
						document.getElementById("thread-list").appendChild(message)
						ScrollBottomInThread()
					}else{
						alert("Something weng wrong...")
					}
				})
			}
		})

		content_input.addEventListener("keyup", function(){
			if(!this.checkValidity() || !this.value){
			    send_btn.disabled = true
			}else{
			    send_btn.disabled = false
			}
		});

		// Forzar el Scroll
		function ScrollBottomInThread(){
			var thread = document.getElementById("thread")
			thread.scrollTop = thread.scrollHeight
		}

        ScrollBottomInThread()
        
    </script>
    
{% endblock extra_scripts %}