{% extends "blog/base.html" %}

{% load crispy_forms_tags %}

{% block content %}
    <article class="media content-section">
        <img class="rounded-circle article-img" src="{{ post.author.profile.image.url }}" />
        <div class="media-body">
            <div class="article-metadata">
                <a class="mr-2" href="{% url 'blog:user_posts' post.author.username %}">{{ post.author }}</a>
                <small class="text-muted">{{ post.created_at | date:'F d, Y H:i' }}</small>              
            </div>
            <h2 class="article-title">{{ post.title }}</h2>
            <p class="article-content">{{ post.content }}</p>
            {% if post.author == user %}
            <div>
                <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'blog:post_update' post.id %}">Update</a>
                <a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'blog:post_delete' post.id %}">Delete</a>
            </div>
            {% endif %}
            <a href="#" class="btn btn-danger btn-circle vote_btn" data-like="0" data-url="{% url 'blog:vote' post.id 'post' %}" role="button">Dislike {{ post.get_dislikes }}</a>
            <a href="#" class="btn btn-success btn-circle vote_btn" data-like="1" data-url="{% url 'blog:vote' post.id 'post' %}" role="button">Like {{ post.get_likes }}</a>
        </div>
    </article>

    {% if request.user.is_authenticated %}
    <h4 class="article-title">Leave a Comment</h4>
    <article class="media content-section mt-3">
        <img class="rounded-circle article-img" src="{{ request.user.profile.image.url }}" />
        <div class="media-body">
            <form method="POST">
                {% csrf_token %}
                {{ form | crispy }}
                <button class="btn btn-primary mr-1 float-right" type="submit">Comment</button>
            </form>
        </div>
    </article>
    {% endif %}

    {% if comments %}

    <h4 class="article-title">{{ comments.count }} comment{{ comments.count | pluralize }}</h4>

    <article class="media content-section mt-3">        
        <div class="media-body">
            {% for item in comments.all %}
            <div class="media" style="margin-top: 30px;">
                <img class="rounded-circle comment-img" src="{{ item.author.profile.image.url }}" />
                <div class="media-body">
                    <h6>
                        <a class="mr-2" href="{% url 'blog:user_posts' item.author.username %}">
                            {{ item.author }}
                        </a>
                        <small class="text-muted">{{ item.created_at | date:'F d, Y H:i' }}</small></h6>
                    {{ item.content}}
                </div>
                <a href="#" class="btn btn-danger btn-circle vote_btn" data-like="0" data-url="{% url 'blog:vote' item.id 'comment' %}" role="button">Dislike {{ item.get_dislikes }}</a>
                <a href="#" class="btn btn-success btn-circle vote_btn" data-like="1" data-url="{% url 'blog:vote' item.id 'comment' %}" role="button">Like {{ item.get_likes }}</a>
            </div>
            {% endfor %}
        </div>
    </article>

    {% else %}

    <h4 class="article-title">No comments yet</h4>

    {% endif %}


{% endblock content %}

{% block extra_scripts %}
<script>
    $(document).ready(function(){
        $(".vote_btn").click(function(e){
            e.preventDefault();

            var like = $(this).data("like");
            var url = $(this).data("url");

            $.ajax({
                type: "POST",
                url: url,            
                data: {csrfmiddlewaretoken: "{{ csrf_token }}", 'like': like}
            })
            .done(function (response) {

            })          
        });
    });
</script>
{% endblock extra_scripts %}